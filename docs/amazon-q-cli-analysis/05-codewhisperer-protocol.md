# CodeWhisperer 协议详解

## 协议概述

Amazon CodeWhisperer 是 AWS 提供的 AI 代码助手服务。CLI 通过 HTTP/HTTPS 与 CodeWhisperer API 通信，使用 JSON 格式进行数据交换。

## API 客户端架构

### 1. 客户端类型

项目包含三个主要的 API 客户端：

```rust
// 标准 HTTP 客户端 - 用于常规请求/响应
amzn-codewhisperer-client

// 流式客户端 - 用于实时通信
amzn-codewhisperer-streaming-client

// Q Developer 专用流式客户端
amzn-qdeveloper-streaming-client
```

### 2. 客户端生成

这些客户端都是从 Smithy 模型自动生成的：

```
// 代码生成标记
// Code generated by software.amazon.smithy.rust.codegen.smithy-rs. DO NOT EDIT.
```

## API 操作列表

### 代码补全相关

#### generate_completions
生成代码补全建议。

**请求**:
```rust
GenerateCompletionsInput {
    file_context: FileContext {
        filename: String,
        programming_language: ProgrammingLanguage,
        left_file_content: String,     // 光标左侧内容
        right_file_content: String,    // 光标右侧内容
    },
    max_results: Option<i32>,
    supplemental_contexts: Vec<SupplementalContext>,
}
```

**响应**:
```rust
GenerateCompletionsOutput {
    completions: Vec<Completion> {
        content: String,              // 建议的代码
        references: Vec<Reference>,   // 代码引用
        completion_id: String,
    },
    next_token: Option<String>,
}
```

### 聊天和对话相关

#### send_message (流式)
发送聊天消息并接收流式响应。

**请求**:
```rust
SendMessageInput {
    conversation_state: ConversationState {
        conversation_id: Option<String>,
        history: Vec<ChatMessage>,
        current_message: ChatMessage {
            user_input_message: UserInputMessage {
                content: String,
                user_input_message_context: UserInputMessageContext,
            },
        },
    },
    user_context: UserContext,
}
```

**流式响应事件**:
```rust
// 事件流包含多种事件类型：

AssistantResponseEvent {
    content: String,                 // 响应内容片段
}

CodeReferenceEvent {
    references: Vec<Reference>,      // 代码引用信息
}

InvalidStateEvent {
    reason: String,
    message: String,
}

ConversationIDEvent {
    conversation_id: String,
}

Error {
    message: String,
}
```

### 代码分析相关

#### start_code_analysis
启动代码安全性和质量分析。

**请求**:
```rust
StartCodeAnalysisInput {
    artifacts: Vec<Artifact> {
        key: String,
        upload_id: String,
        upload_context: CodeAnalysisUploadContext,
    },
    programming_language: ProgrammingLanguage,
    code_analysis_scope: CodeAnalysisScope,
}
```

**响应**:
```rust
StartCodeAnalysisOutput {
    job_id: String,
    status: CodeAnalysisStatus,     // Pending, Running, Completed, Failed
}
```

#### get_code_analysis
获取代码分析结果。

**请求**:
```rust
GetCodeAnalysisInput {
    job_id: String,
}
```

**响应**:
```rust
GetCodeAnalysisOutput {
    status: CodeAnalysisStatus,
    response_context: String,
    findings: Vec<Diagnostic> {
        message: String,
        severity: DiagnosticSeverity,  // Error, Warning, Information, Hint
        range: Range {
            start: Position { line, character },
            end: Position { line, character },
        },
        code: String,
        source: String,
        suggested_fixes: Vec<SuggestedFix>,
    },
}
```

#### list_code_analysis_findings
列出代码分析发现的问题。

**请求**:
```rust
ListCodeAnalysisFindingsInput {
    job_id: String,
    next_token: Option<String>,
    code_analysis_findings_schema: CodeAnalysisFindingsSchema,
}
```

### 测试生成相关

#### start_test_generation
启动单元测试生成任务。

**请求**:
```rust
StartTestGenerationInput {
    conversation_state: ConversationState,
    target_file_info: TargetFileInfo {
        file_path: String,
        programming_language: ProgrammingLanguage,
    },
}
```

**响应**:
```rust
StartTestGenerationOutput {
    test_generation_id: String,
    test_generation_job: TestGenerationJob {
        status: TestGenerationJobStatus,  // InProgress, Completed, Failed
        created_time: DateTime,
    },
}
```

#### get_test_generation
获取测试生成结果。

**请求**:
```rust
GetTestGenerationInput {
    test_generation_id: String,
    conversation_state: ConversationState,
}
```

**响应**:
```rust
GetTestGenerationOutput {
    test_generation_job: TestGenerationJob,
    target_code: TargetCode {
        content: String,
        file_path: String,
    },
}
```

### 代码转换相关

#### start_transformation
启动代码转换任务（如 Java 版本升级）。

**请求**:
```rust
StartTransformationInput {
    transformation_spec: TransformationSpec {
        transformation_language: TransformationLanguage,  // Java
        source_runtime_env: TransformationJavaRuntimeEnv,
        target_runtime_env: TransformationJavaRuntimeEnv,
    },
    upload_id: String,
}
```

**响应**:
```rust
StartTransformationOutput {
    transformation_job_id: String,
}
```

#### get_transformation
获取转换任务状态。

**请求**:
```rust
GetTransformationInput {
    transformation_job_id: String,
}
```

**响应**:
```rust
GetTransformationOutput {
    transformation_job: TransformationJob {
        status: TransformationStatus,  // Created, Prepared, Planning, Transforming, Completed, Stopped, Failed
        transformation_plan: Option<TransformationPlan>,
        progress_updates: Vec<TransformationProgressUpdate>,
    },
}
```

#### get_transformation_plan
获取转换计划详情。

**请求**:
```rust
GetTransformationPlanInput {
    transformation_job_id: String,
}
```

**响应**:
```rust
GetTransformationPlanOutput {
    transformation_plan: TransformationPlan {
        transformation_steps: Vec<TransformationStep>,
    },
}
```

#### stop_transformation
停止正在进行的转换任务。

### 代码修复相关

#### start_code_fix_job
启动自动代码修复任务。

**请求**:
```rust
StartCodeFixJobInput {
    message: String,
    upload_context: CodeFixUploadContext,
}
```

**响应**:
```rust
StartCodeFixJobOutput {
    code_fix_job_id: String,
}
```

#### get_code_fix_job
获取代码修复任务状态和结果。

### Task Assist (任务辅助) 相关

#### create_task_assist_conversation
创建任务辅助对话。

#### start_task_assist_code_generation
启动任务辅助的代码生成。

**请求**:
```rust
StartTaskAssistCodeGenerationInput {
    conversation_id: String,
    upload_context: TaskAssistPlanningUploadContext,
    message: String,
}
```

#### get_task_assist_code_generation (流式)
获取任务辅助生成的代码（流式）。

#### delete_task_assist_conversation
删除任务辅助对话。

### 模型和配置相关

#### list_available_models
列出可用的 AI 模型。

**请求**:
```rust
ListAvailableModelsInput {
    // 通常为空或包含过滤条件
}
```

**响应**:
```rust
ListAvailableModelsOutput {
    models: Vec<Model> {
        model_id: String,
        model_name: String,
        provider: ModelProvider,   // Amazon, Anthropic, etc.
        capabilities: Vec<String>,
    },
    default_model: Option<Model>,
}
```

#### list_available_customizations
列出可用的自定义配置。

**请求**:
```rust
ListAvailableCustomizationsInput {
    max_results: Option<i32>,
    next_token: Option<String>,
}
```

**响应**:
```rust
ListAvailableCustomizationsOutput {
    customizations: Vec<Customization> {
        arn: String,
        name: String,
        description: String,
    },
}
```

#### list_available_profiles
列出可用的配置文件。

**响应**:
```rust
ListAvailableProfilesOutput {
    profiles: Vec<ProfileInfo> {
        profile_id: String,
        profile_name: String,
        profile_type: ProfileType,
    },
}
```

#### get_profile
获取用户配置文件详情。

**响应**:
```rust
GetProfileOutput {
    profile: Profile {
        profile_id: String,
        profile_status: ProfileStatus,
        opt_in_features: OptInFeatures,
        usage_limits: UsageLimits,
        subscription_info: SubscriptionInfo,
    },
}
```

### 订阅相关

#### list_available_subscriptions
列出可用的订阅计划。

**响应**:
```rust
ListAvailableSubscriptionsOutput {
    subscriptions: Vec<SubscriptionPlanDescription> {
        subscription_name: SubscriptionName,  // Free, Professional, Enterprise
        subscription_status: SubscriptionStatus,
        features: Vec<String>,
        pricing_info: PricingInfo,
    },
}
```

#### create_subscription_token
创建订阅令牌。

**响应**:
```rust
CreateSubscriptionTokenOutput {
    token: String,
    expires_at: DateTime,
}
```

### 使用限制相关

#### get_usage_limits
获取当前使用限制和使用情况。

**响应**:
```rust
GetUsageLimitsOutput {
    token_limits: TokenLimits {
        max_tokens_per_month: i64,
        tokens_used: i64,
        tokens_remaining: i64,
    },
    overage_status: OverageStatus,
    overage_configuration: OverageConfiguration,
}
```

#### update_usage_limits
更新使用限制设置。

### 遥测相关

#### send_telemetry_event
发送遥测事件。

**请求**:
```rust
SendTelemetryEventInput {
    telemetry_event: TelemetryEvent {
        event: Event,              // 各种事件类型的枚举
        user_context: UserContext,
    },
}
```

**事件类型包括**:
- CodeScanEvent - 代码扫描事件
- CodeCoverageEvent - 代码覆盖率事件
- ChatAddMessageEvent - 聊天消息事件
- CodeFixGenerationEvent - 代码修复生成事件
- TestGenerationEvent - 测试生成事件
- TransformEvent - 转换事件
- FeatureDevEvent - 功能开发事件
- 等等...

#### push_telemetry_event
批量推送遥测事件。

### 工作区和上传相关

#### create_workspace
创建工作区。

#### delete_workspace
删除工作区。

#### list_workspace_metadata
列出工作区元数据。

#### create_upload_url
创建上传 URL（用于上传代码文件）。

**请求**:
```rust
CreateUploadUrlInput {
    content_checksum: String,
    content_checksum_type: ContentChecksumType,  // SHA256
    artifact_type: ArtifactType,
}
```

**响应**:
```rust
CreateUploadUrlOutput {
    upload_id: String,
    upload_url: String,
    request_headers: HashMap<String, String>,
}
```

#### create_artifact_upload_url
创建构件上传 URL。

### 用户记忆相关

#### create_user_memory_entry
创建用户记忆条目。

**请求**:
```rust
CreateUserMemoryEntryInput {
    memory_entry: MemoryEntry {
        content: String,
        metadata: MemoryEntryMetadata,
    },
}
```

#### list_user_memory_entries
列出用户记忆条目。

#### delete_user_memory_entry
删除用户记忆条目。

### 语义搜索相关

#### get_retrievals
获取语义搜索结果。

**请求**:
```rust
GetRetrievalsInput {
    query: String,
    workspace_id: String,
}
```

**响应**:
```rust
GetRetrievalsOutput {
    retrievals: Vec<Retrieval> {
        content: String,
        source: String,
        relevance_score: f64,
    },
}
```

### 特性评估相关

#### list_feature_evaluations
列出功能特性评估。

**响应**:
```rust
ListFeatureEvaluationsOutput {
    feature_evaluations: Vec<FeatureEvaluation> {
        feature: String,
        variation: String,
        value: FeatureValue,
    },
}
```

### 用户偏好设置

#### set_user_preference
设置用户偏好。

**请求**:
```rust
SetUserPreferenceInput {
    opt_out_preferences: Vec<OptOutPreference>,
}
```

### 事件列表

#### list_events
列出事件（用于通知和 Feed）。

**响应**:
```rust
ListEventsOutput {
    events: Vec<Event>,
    next_token: Option<String>,
}
```

## 核心数据类型

### UserContext
用户上下文信息，几乎所有请求都需要。

```rust
pub struct UserContext {
    pub ide_category: IdeCategory,           // VSCode, JetBrains, etc.
    pub operating_system: OperatingSystem,   // MacOS, Linux, Windows
    pub product: String,                     // "Amazon Q CLI"
    pub client_id: String,
    pub ide_version: Option<String>,
    pub custom_usage_data: Option<Map<String, Value>>,
}
```

### ConversationState
对话状态，用于维护多轮对话。

```rust
pub struct ConversationState {
    pub conversation_id: Option<String>,
    pub history: Vec<ChatMessage>,
    pub current_message: ChatMessage,
    pub chat_trigger_type: Option<ChatTriggerType>,
}
```

### ChatMessage
聊天消息。

```rust
pub enum ChatMessage {
    UserInputMessage(UserInputMessage),
    AssistantResponseMessage(AssistantResponseMessage),
}

pub struct UserInputMessage {
    pub content: String,
    pub user_input_message_context: Option<UserInputMessageContext>,
}

pub struct UserInputMessageContext {
    pub editor_state: Option<EditorState>,
    pub diagnostic: Option<Diagnostic>,
    pub shell_state: Option<ShellState>,
    pub git_state: Option<GitState>,
    pub env_state: Option<EnvState>,
    pub console_state: Option<ConsoleState>,
    pub focused_element_context: Option<Value>,
}
```

### FileContext
文件上下文，用于代码补全等功能。

```rust
pub struct FileContext {
    pub filename: String,
    pub programming_language: ProgrammingLanguage,
    pub left_file_content: String,
    pub right_file_content: String,
}
```

### ProgrammingLanguage
支持的编程语言枚举。

```rust
pub enum ProgrammingLanguage {
    Python,
    Java,
    JavaScript,
    TypeScript,
    Rust,
    Go,
    CSharp,
    Cpp,
    C,
    PHP,
    Ruby,
    Kotlin,
    Swift,
    Shell,
    SQL,
    // ... 更多语言
}
```

### Model
AI 模型信息。

```rust
pub struct Model {
    pub model_id: String,
    pub model_name: String,
    pub provider: ModelProvider,
    pub model_arn: Option<String>,
}

pub enum ModelProvider {
    Amazon,
    Anthropic,
    Meta,
    AI21,
    Cohere,
}
```

### Reference
代码引用信息（用于归属）。

```rust
pub struct Reference {
    pub license_name: Option<String>,
    pub repository: Option<String>,
    pub url: Option<String>,
    pub recommendation_content_span: Option<Span>,
}
```

### Diagnostic
诊断信息（代码问题）。

```rust
pub struct Diagnostic {
    pub message: String,
    pub severity: DiagnosticSeverity,
    pub range: Range,
    pub code: Option<String>,
    pub source: Option<String>,
    pub related_information: Vec<DiagnosticRelatedInformation>,
    pub suggested_fixes: Vec<SuggestedFix>,
}

pub enum DiagnosticSeverity {
    Error,
    Warning,
    Information,
    Hint,
}
```

### SubscriptionStatus
订阅状态。

```rust
pub enum SubscriptionStatus {
    Active,
    Inactive,
    PendingActivation,
    Cancelled,
    FreeTrial,
}
```

## 协议特性

### 1. 流式响应

使用 Server-Sent Events (SSE) 或 Event Stream 进行实时通信。

```rust
// 流式响应处理
let mut stream = client
    .send_message()
    .conversation_state(conversation_state)
    .send()
    .await?;

while let Some(event) = stream.next().await {
    match event? {
        SendMessageResponseStream::AssistantResponseEvent(event) => {
            print!("{}", event.content);
        }
        SendMessageResponseStream::CodeReferenceEvent(event) => {
            // 处理代码引用
        }
        SendMessageResponseStream::Error(e) => {
            eprintln!("Error: {}", e.message);
        }
        _ => {}
    }
}
```

### 2. 分页

许多列表操作支持分页。

```rust
let mut next_token = None;
loop {
    let response = client
        .list_code_analysis_findings()
        .job_id(job_id)
        .set_next_token(next_token.clone())
        .send()
        .await?;
    
    // 处理结果
    for finding in response.findings.unwrap_or_default() {
        println!("{:?}", finding);
    }
    
    next_token = response.next_token;
    if next_token.is_none() {
        break;
    }
}
```

### 3. 请求重试

使用指数退避策略进行重试。

```rust
// 在 API 客户端配置中
let retry_config = RetryConfig::standard()
    .with_max_attempts(3)
    .with_initial_backoff(Duration::from_millis(100))
    .with_max_backoff(Duration::from_secs(10));
```

### 4. 超时控制

```rust
let timeout_config = TimeoutConfig::builder()
    .operation_timeout(Duration::from_secs(300))
    .connect_timeout(Duration::from_secs(10))
    .build();
```

### 5. 选择退出 (Opt-Out)

通过请求头控制数据收集。

```rust
// x-amzn-codewhisperer-optout 头
pub const X_AMZN_CODEWHISPERER_OPT_OUT_HEADER: &str = "x-amzn-codewhisperer-optout";
```

## 端点配置

### 默认端点

```rust
pub enum Endpoint {
    Prod,       // 生产环境
    Gamma,      // Gamma 环境
    Beta,       // Beta 环境
    Custom(String),
}

// 生产端点示例
https://codewhisperer.us-east-1.amazonaws.com
```

### 区域支持

支持多个 AWS 区域，但不支持 GovCloud 区域。

## 错误处理

### 错误类型

```rust
pub enum ApiClientError {
    // HTTP 错误
    HttpError(reqwest::Error),
    
    // 服务错误
    AccessDeniedException,
    ThrottlingException,
    ValidationException,
    InternalServerException,
    ServiceQuotaExceededException,
    ConflictException,
    
    // 认证错误
    UnauthorizedException,
    
    // 其他错误
    InvalidRequestException,
}
```

### 错误响应格式

```json
{
    "message": "Error message",
    "reason": "ACCESS_DENIED",
    "__type": "AccessDeniedException"
}
```

## 请求和响应示例

### 示例 1: 代码补全

**请求**:
```json
POST /completions
Authorization: Bearer <token>

{
    "fileContext": {
        "filename": "main.py",
        "programmingLanguage": "Python",
        "leftFileContent": "def calculate_sum(a, b):\n    ",
        "rightFileContent": ""
    },
    "maxResults": 5
}
```

**响应**:
```json
{
    "completions": [
        {
            "content": "return a + b",
            "completionId": "comp-123",
            "references": []
        }
    ]
}
```

### 示例 2: 发送聊天消息

**请求**:
```json
POST /conversation/sendMessage

{
    "conversationState": {
        "currentMessage": {
            "userInputMessage": {
                "content": "How do I read a file in Python?"
            }
        }
    }
}
```

**流式响应** (SSE):
```
event: assistantResponseEvent
data: {"content": "To read"}

event: assistantResponseEvent
data: {"content": " a file"}

event: assistantResponseEvent
data: {"content": " in Python"}

event: conversationIdEvent
data: {"conversationId": "conv-123"}
```

## 总结

CodeWhisperer 协议提供了丰富的 API 操作，涵盖：
- 代码补全和生成
- 代码分析和修复
- 测试生成
- 代码转换
- 聊天对话
- 模型和配置管理
- 遥测和分析

所有操作都使用 HTTPS 和 Bearer Token 认证，支持流式响应和分页，具有完善的错误处理机制。
