# AWS CodeWhisperer Streaming Client Usage Guide

## Overview

`@aws/codewhisperer-streaming-client` is an internal AWS npm package that provides a complete client implementation for the AWS CodeWhisperer Streaming API. This guide documents its usage based on reverse-engineering the package's TypeScript definitions.

**Package Version:** 1.0.26  
**Note:** This is an internal AWS package with no official public documentation.

## Table of Contents

1. [Main Classes](#main-classes)
2. [Authentication](#authentication)
3. [Available Commands](#available-commands)
4. [Data Models](#data-models)
5. [Usage Examples](#usage-examples)
6. [Event Stream Handling](#event-stream-handling)

## Main Classes

### CodeWhispererStreamingClient

The main client class for interacting with the CodeWhisperer Streaming API.

```typescript
import { CodeWhispererStreamingClient } from '@aws/codewhisperer-streaming-client';

const client = new CodeWhispererStreamingClient({
  region: 'us-east-1',
  // Authentication options - see Authentication section
});
```

#### Configuration Options

```typescript
interface CodeWhispererStreamingClientConfig {
  // AWS Region
  region?: string;
  
  // Custom endpoint URL (optional)
  endpoint?: string;
  
  // Credentials provider or static credentials
  credentials?: AwsCredentialIdentity | Provider<AwsCredentialIdentity>;
  
  // Retry configuration
  maxAttempts?: number;
  retryMode?: string;
  
  // Logger for debugging
  logger?: Logger;
  
  // Event stream serialization provider
  eventStreamSerdeProvider?: EventStreamSerdeProvider;
  
  // Other AWS SDK standard options...
}
```

## Authentication

The client supports Bearer token authentication, which is compatible with AWS Builder ID SSO tokens:

```typescript
import { CodeWhispererStreamingClient } from '@aws/codewhisperer-streaming-client';
import { fromTokenProvider } from '@aws-sdk/token-providers';

// Option 1: Using a token provider function
const client = new CodeWhispererStreamingClient({
  region: 'us-east-1',
  token: async () => ({
    token: 'your-bearer-token-here',
  }),
});

// Option 2: Custom credential resolver
const client = new CodeWhispererStreamingClient({
  region: 'us-east-1',
  credentials: async () => ({
    accessKeyId: '',  // Not used for Bearer auth
    secretAccessKey: '',  // Not used for Bearer auth
    sessionToken: 'your-bearer-token-here',
  }),
});
```

## Available Commands

### 1. SendMessageCommand

Send a message in a conversation and receive streaming responses.

```typescript
import { SendMessageCommand } from '@aws/codewhisperer-streaming-client';

const command = new SendMessageCommand({
  conversationState: {
    conversationId: 'conversation-uuid',  // Optional for first message
    currentMessage: {
      userInputMessage: {
        content: 'Your message here',
        userInputMessageContext: {
          // Optional context about editor state, shell, etc.
        },
      },
    },
    chatTriggerType: 'MANUAL',  // 'MANUAL' | 'DIAGNOSTIC' | 'INLINE_CHAT'
    history: [
      // Previous messages in the conversation
    ],
  },
  profileArn: 'optional-profile-arn',
  source: 'optional-source',
});

const response = await client.send(command);
```

### 2. GenerateAssistantResponseCommand

Generate an assistant response (similar to SendMessage but different API surface).

```typescript
import { GenerateAssistantResponseCommand } from '@aws/codewhisperer-streaming-client';

const command = new GenerateAssistantResponseCommand({
  conversationState: {
    // Same structure as SendMessageCommand
  },
});

const response = await client.send(command);
```

### 3. GenerateTaskAssistPlanCommand

Generate a task assistance plan for complex operations.

```typescript
import { GenerateTaskAssistPlanCommand } from '@aws/codewhisperer-streaming-client';

const command = new GenerateTaskAssistPlanCommand({
  // Task-specific request parameters
});

const response = await client.send(command);
```

### 4. ExportResultArchiveCommand

Export a result archive from a conversation or task.

```typescript
import { ExportResultArchiveCommand } from '@aws/codewhisperer-streaming-client';

const command = new ExportResultArchiveCommand({
  // Export-specific parameters
});

const response = await client.send(command);
```

## Data Models

### ConversationState

The main structure for managing conversation state:

```typescript
interface ConversationState {
  // Unique identifier for the conversation (generated by the service)
  conversationId?: string;
  
  // Optional workspace identifier
  workspaceId?: string;
  
  // History of previous messages
  history?: ChatMessage[];
  
  // The current message being sent
  currentMessage: ChatMessage;
  
  // How the chat was triggered
  chatTriggerType: 'MANUAL' | 'DIAGNOSTIC' | 'INLINE_CHAT';
  
  // Optional customization ARN for custom models
  customizationArn?: string;
  
  // Agent continuation identifier
  agentContinuationId?: string;
  
  // Agent task type
  agentTaskType?: 'vibe' | 'spectask';
}
```

### ChatMessage

Union type representing either a user or assistant message:

```typescript
type ChatMessage = {
  userInputMessage?: UserInputMessage;
  assistantResponseMessage?: AssistantResponseMessage;
};

interface UserInputMessage {
  // The message content
  content: string;
  
  // Context information (optional)
  userInputMessageContext?: {
    // Editor state (document, cursor position, etc.)
    editorState?: EditorState;
    
    // Shell/terminal context
    shellState?: ShellState;
    
    // Git repository state
    gitState?: GitState;
    
    // Environment variables and OS info
    envState?: EnvState;
    
    // Diagnostic information (errors, warnings)
    diagnostic?: Diagnostic;
    
    // Tool definitions for tool calling
    tools?: Tool[];
    
    // Tool results from previous tool calls
    toolResults?: ToolResult[];
  };
  
  // User intent classification
  userIntent?: 
    | 'SUGGEST_ALTERNATE_IMPLEMENTATION'
    | 'APPLY_COMMON_BEST_PRACTICES'
    | 'IMPROVE_CODE'
    | 'SHOW_EXAMPLES'
    | 'CITE_SOURCES'
    | 'EXPLAIN_LINE_BY_LINE'
    | 'EXPLAIN_CODE_SELECTION'
    | 'GENERATE_CLOUDFORMATION_TEMPLATE'
    | 'GENERATE_UNIT_TESTS'
    | 'CODE_GENERATION';
  
  // Origin of the message
  origin?: string;
  
  // Image attachments
  images?: ImageBlock[];
  
  // Model identifier
  modelId?: string;
}

interface AssistantResponseMessage {
  // Message identifier
  messageId?: string;
  
  // The response content
  content: string;
  
  // Web links for supplementary information
  supplementaryWebLinks?: SupplementaryWebLink[];
  
  // Code references/citations
  references?: Reference[];
  
  // Suggested follow-up prompt
  followupPrompt?: FollowupPrompt;
  
  // Tool uses (function calls)
  toolUses?: ToolUse[];
}
```

### Tool Support

CodeWhisperer supports tool calling (similar to OpenAI function calling):

```typescript
interface Tool {
  toolSpecification?: {
    name: string;
    description?: string;
    inputSchema: {
      json: any;  // JSON Schema for tool parameters
    };
  };
}

interface ToolUse {
  toolUseId: string;
  name: string;
  input: any;  // Tool input parameters
}

interface ToolResult {
  toolUseId: string;
  content: ToolResultContentBlock[];
  status?: 'success' | 'error';
}

type ToolResultContentBlock = {
  text?: string;
  json?: any;
};
```

## Event Stream Handling

The response from `SendMessageCommand` and `GenerateAssistantResponseCommand` is an event stream:

```typescript
interface SendMessageResponse {
  sendMessageResponse: AsyncIterable<ChatResponseStream>;
}

// ChatResponseStream is a union type of various event types
type ChatResponseStream = 
  | { messageMetadataEvent: MessageMetadataEvent }
  | { assistantResponseEvent: AssistantResponseEvent }
  | { reasoningContentEvent: ReasoningContentEvent }
  | { codeReferenceEvent: CodeReferenceEvent }
  | { supplementaryWebLinksEvent: SupplementaryWebLinksEvent }
  | { followupPromptEvent: FollowupPromptEvent }
  | { codeEvent: CodeEvent }
  | { intentsEvent: IntentsEvent }
  | { interactionComponentsEvent: InteractionComponentsEvent }
  | { invalidStateEvent: InvalidStateEvent }
  | { error: Error };
```

### Event Types

1. **messageMetadataEvent** - Contains conversation and utterance IDs
   ```typescript
   interface MessageMetadataEvent {
     conversationId?: string;
     utteranceId?: string;
   }
   ```

2. **assistantResponseEvent** - Text content from the assistant
   ```typescript
   interface AssistantResponseEvent {
     content: string;
     modelId?: string;
   }
   ```

3. **codeEvent** - Code blocks in the response
   ```typescript
   interface CodeEvent {
     content: string;
   }
   ```

4. **codeReferenceEvent** - Code references/citations
   ```typescript
   interface CodeReferenceEvent {
     references: Reference[];
   }
   ```

5. **invalidStateEvent** - Error state
   ```typescript
   interface InvalidStateEvent {
     reason: string;
     message: string;
   }
   ```

## Usage Examples

### Basic Chat Conversation

```typescript
import { 
  CodeWhispererStreamingClient,
  SendMessageCommand 
} from '@aws/codewhisperer-streaming-client';

async function chat() {
  const client = new CodeWhispererStreamingClient({
    region: 'us-east-1',
    token: async () => ({ token: await getAuthToken() }),
  });

  const command = new SendMessageCommand({
    conversationState: {
      currentMessage: {
        userInputMessage: {
          content: 'Hello, can you help me write a function?',
        },
      },
      chatTriggerType: 'MANUAL',
    },
  });

  const response = await client.send(command);
  
  // Iterate over the event stream
  for await (const event of response.sendMessageResponse) {
    if ('messageMetadataEvent' in event) {
      console.log('Conversation ID:', event.messageMetadataEvent.conversationId);
    } else if ('assistantResponseEvent' in event) {
      process.stdout.write(event.assistantResponseEvent.content);
    } else if ('codeEvent' in event) {
      process.stdout.write(event.codeEvent.content);
    }
  }
}
```

### Conversation with History

```typescript
async function continueConversation(conversationId: string) {
  const client = new CodeWhispererStreamingClient({
    region: 'us-east-1',
    token: async () => ({ token: await getAuthToken() }),
  });

  const command = new SendMessageCommand({
    conversationState: {
      conversationId,
      history: [
        {
          userInputMessage: {
            content: 'Previous user message',
          },
        },
        {
          assistantResponseMessage: {
            content: 'Previous assistant response',
          },
        },
      ],
      currentMessage: {
        userInputMessage: {
          content: 'Follow-up question',
        },
      },
      chatTriggerType: 'MANUAL',
    },
  });

  const response = await client.send(command);
  // Process response...
}
```

### Using Tool Calling

```typescript
async function chatWithTools() {
  const client = new CodeWhispererStreamingClient({
    region: 'us-east-1',
    token: async () => ({ token: await getAuthToken() }),
  });

  const tools: Tool[] = [
    {
      toolSpecification: {
        name: 'get_weather',
        description: 'Get the current weather for a location',
        inputSchema: {
          json: {
            type: 'object',
            properties: {
              location: {
                type: 'string',
                description: 'City name',
              },
            },
            required: ['location'],
          },
        },
      },
    },
  ];

  const command = new SendMessageCommand({
    conversationState: {
      currentMessage: {
        userInputMessage: {
          content: 'What is the weather in Seattle?',
          userInputMessageContext: {
            tools,
          },
        },
      },
      chatTriggerType: 'MANUAL',
    },
  });

  const response = await client.send(command);
  const toolUses: any[] = [];
  
  for await (const event of response.sendMessageResponse) {
    if ('assistantResponseEvent' in event) {
      // Handle response...
    }
    // Tool use events would be in the assistant response message
    // if tools are called
  }
}
```

### Providing Tool Results

```typescript
async function provideToolResults(conversationId: string) {
  const client = new CodeWhispererStreamingClient({
    region: 'us-east-1',
    token: async () => ({ token: await getAuthToken() }),
  });

  const toolResults: ToolResult[] = [
    {
      toolUseId: 'tool-use-id-from-previous-response',
      content: [
        {
          text: JSON.stringify({ temperature: 72, condition: 'sunny' }),
        },
      ],
      status: 'success',
    },
  ];

  const command = new SendMessageCommand({
    conversationState: {
      conversationId,
      currentMessage: {
        userInputMessage: {
          content: '', // Empty content when just providing tool results
          userInputMessageContext: {
            toolResults,
          },
        },
      },
      chatTriggerType: 'MANUAL',
    },
  });

  const response = await client.send(command);
  // Process response...
}
```

## Error Handling

```typescript
import { CodeWhispererStreamingServiceException } from '@aws/codewhisperer-streaming-client';

try {
  const response = await client.send(command);
  for await (const event of response.sendMessageResponse) {
    if ('invalidStateEvent' in event) {
      console.error('Invalid state:', event.invalidStateEvent);
      break;
    }
    // Process other events...
  }
} catch (error) {
  if (error instanceof CodeWhispererStreamingServiceException) {
    console.error('Service error:', error.name, error.message);
  } else {
    console.error('Unexpected error:', error);
  }
}
```

## Best Practices

1. **Always handle all event types** - The event stream can contain various event types, and you should handle all of them gracefully.

2. **Preserve conversation ID** - Store the conversation ID from `messageMetadataEvent` to continue conversations.

3. **Handle tool calling properly** - When tools are invoked, make sure to execute them and provide results back.

4. **Set appropriate context** - Provide relevant context (editor state, shell history, etc.) for better responses.

5. **Use proper chat trigger types** - Set the correct `chatTriggerType` based on how the conversation started.

6. **Error recovery** - Always handle `invalidStateEvent` and service exceptions properly.

7. **Token refresh** - Implement token refresh logic in your token provider to handle expired tokens.

## Differences from OpenAI API

| Feature | OpenAI | CodeWhisperer |
|---------|--------|---------------|
| Streaming | Server-Sent Events | Event Stream (binary) |
| Message format | Simple role/content | Complex nested structure |
| Tool calling | `functions` or `tools` | `tools` in context |
| Tool results | Separate message role | In `toolResults` array |
| Conversation tracking | Client-managed | Server-managed with ID |
| Context | Just messages | Rich context (editor, shell, git, etc.) |

## Limitations and Notes

1. This is an **internal AWS package** - No official support or documentation
2. API may change without notice in future versions
3. Some fields may be deprecated or experimental
4. Not all features may be available depending on your AWS account/region
5. Performance may vary based on model and region
6. Event stream format is binary and requires proper deserialization

## Additional Resources

- Package on npm: https://www.npmjs.com/package/@aws/codewhisperer-streaming-client
- AWS SDK for JavaScript v3: https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/
- CodeWhisperer documentation: https://docs.aws.amazon.com/codewhisperer/
