# 调试日志说明

## 问题描述

您报告运行 `npm run cli test "写一个快速排序算法"` 时，程序没有输出任何结果就结束了。

## 已添加的改进

### 1. 详细的调试日志

我在代码中添加了大量的调试日志，帮助您诊断问题：

#### CodeWhisperer API 客户端调试
文件：`src/codewhisperer-client.ts`

- **API 请求和响应**：
  - HTTP 响应状态码
  - 响应头信息
  - 错误详情（如果有）

- **事件流解析**：
  - 每个接收到的数据块的大小和内容
  - 解析出的每个事件的完整内容
  - 统计信息（总共接收了多少数据块，解析了多少个事件）

#### CLI 工具调试
文件：`src/cli.ts`

- **事件处理**：
  - 每个接收到的事件的完整内容
  - 事件类型识别
  - 未知事件类型的警告

### 2. 修复的 Bug

在添加调试日志时，我发现并修复了示例代码中的一个bug：

**问题**：`examples/basic-usage.ts` 和 `examples/tool-calling.ts` 中使用了错误的 `chatTriggerType` 值。

- ❌ 错误：`chatTriggerType: 'Manual'`
- ✅ 正确：`chatTriggerType: 'MANUAL'`

根据类型定义，`chatTriggerType` 必须是大写的 `'MANUAL'`、`'DIAGNOSTIC'` 或 `'INLINE_CHAT'`。

**注意**：您的 CLI 命令使用的是正确的值 `'MANUAL'`，所以这个bug不影响CLI的使用，只是示例代码的问题。

## 如何使用调试日志

1. 确保已安装依赖：
   ```bash
   npm install
   ```

2. 如果还没有登录，先进行认证：
   ```bash
   npm run cli login
   ```

3. 运行测试命令：
   ```bash
   npm run cli test "写一个快速排序算法"
   ```

4. 查看输出的调试日志，它会显示：
   - `[DEBUG] Request body:` - 发送给 API 的请求内容
   - `[DEBUG] Response status:` - API 响应的状态码
   - `[DEBUG] Response headers:` - API 响应头
   - `[DEBUG] Starting to parse event stream...` - 开始解析事件流
   - `[DEBUG] Received chunk X` - 接收到数据块
   - `[DEBUG] Chunk content:` - 数据块的内容
   - `[DEBUG] Parsed event X:` - 解析出的事件
   - `[DEBUG] CLI received event X:` - CLI 接收到的事件
   - `[DEBUG] Processing xxxEvent` - 正在处理的事件类型

## 可能的问题诊断

根据调试日志的输出，您可以判断问题出在哪里：

### 情况1：认证问题
如果看到类似这样的错误：
```
Not authenticated. Run: npm run cli login
```
解决方法：运行 `npm run cli login` 进行认证

### 情况2：API 返回错误
如果看到：
```
[DEBUG] Response status: 403 Forbidden
```
可能的原因：
- Token 过期或无效
- 没有权限访问 CodeWhisperer API
- 需要重新认证

解决方法：
```bash
rm -rf ~/.codewhisperer-proxy
npm run cli login
```

### 情况3：返回空数据流
如果看到：
```
[DEBUG] Response status: 200 OK
[DEBUG] Stream ended. Received 0 chunks, parsed 0 events
```
可能的原因：
- API 没有返回任何内容
- 网络连接问题
- CodeWhisperer 服务问题

### 情况4：收到数据但解析失败
如果看到接收到数据但没有成功解析的事件，可能是数据格式问题。

### 情况5：收到事件但没有输出
如果调试日志显示收到了事件，但是 `Response:` 后面没有内容，可能是：
- 事件内容为空
- 事件类型不匹配（会显示 "Unknown event type"）

## 示例输出

正常情况下，您应该看到类似这样的输出：

```
Testing CodeWhisperer API...

Question: 写一个快速排序算法

Response:
[DEBUG] Starting to iterate over events...
[DEBUG] Request body: {...}
[DEBUG] Response status: 200 OK
[DEBUG] Response headers: {...}
[DEBUG] Starting to parse event stream...
[DEBUG] Received chunk 1, size: xxx bytes
[DEBUG] Chunk content: ...
[DEBUG] Parsed event 1: {...}
[DEBUG] CLI received event 1: {...}
[DEBUG] Processing assistantResponseEvent
这里是快速排序算法的代码...
[DEBUG] Stream ended. Received X chunks, parsed Y events
[DEBUG] Iteration complete. Received Y events total
```

## 如果问题仍然存在

如果添加了调试日志后仍然没有输出，请：

1. 将完整的调试日志输出保存到文件：
   ```bash
   npm run cli test "写一个快速排序算法" 2>&1 | tee debug.log
   ```

2. 检查 `debug.log` 文件，看看在哪个步骤停止了

3. 确认您的网络可以访问 AWS CodeWhisperer 服务

4. 检查您的 AWS Builder ID 账户是否有使用 CodeWhisperer 的权限

## 后续优化建议

如果这些调试日志帮助您找到了问题，我们可以考虑：

1. 添加环境变量来控制调试日志的开关：
   ```bash
   DEBUG=true npm run cli test "写一个快速排序算法"
   ```

2. 将调试日志输出到单独的文件而不是混在输出中

3. 使用专业的日志库（如 winston 或 pino）来管理日志级别

希望这些调试日志能帮助您找到问题所在！
