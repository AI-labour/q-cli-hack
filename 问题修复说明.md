# 问题修复说明

## 问题分析

你遇到的 400 Bad Request 错误是因为 `chatTriggerType` 字段的值格式不正确。

### 错误的请求格式
```json
{
  "conversationState": {
    "currentMessage": {
      "userInputMessage": {
        "content": "写一个快速排序算法",
        "origin": "CLI"
      }
    },
    "chatTriggerType": "Manual"  ❌ 错误：应该是全大写
  }
}
```

### 正确的请求格式
```json
{
  "conversationState": {
    "currentMessage": {
      "userInputMessage": {
        "content": "写一个快速排序算法",
        "origin": "CLI"
      }
    },
    "chatTriggerType": "MANUAL"  ✅ 正确：全大写
  }
}
```

## 问题根源

通过分析 Amazon Q Developer CLI 官方源码（`amazon-q-developer-cli` 子模块），我发现：

1. **枚举值必须全大写**：在 `_chat_trigger_type.rs` 中定义的序列化规则：
   - `MANUAL` (不是 `Manual`)
   - `DIAGNOSTIC` (不是 `Diagnostic`)
   - `INLINE_CHAT` (不是 `InlineChat`)

2. **官方实现参考**：
   ```rust
   // 位置: crates/amzn-codewhisperer-streaming-client/src/types/_chat_trigger_type.rs
   pub fn as_str(&self) -> &str {
       match self {
           ChatTriggerType::Manual => "MANUAL",
           // ...
       }
   }
   ```

## 已修复的内容

我已经修复了以下文件：

1. ✅ **src/types.ts** - 更新类型定义为 `'MANUAL' | 'DIAGNOSTIC' | 'INLINE_CHAT'`
2. ✅ **src/cli.ts** - 更新 CLI 代码使用 `'MANUAL'`
3. ✅ **src/openai-converter.ts** - 更新转换器使用 `'MANUAL'`
4. ✅ **README.md** - 更新文档示例
5. ✅ **ANALYSIS.md** - 更新 JSON 示例
6. ✅ **src/codewhisperer-client.ts** - 添加请求内容调试日志

## 如何测试

```bash
# 1. 构建项目（已经包含修复）
npm install
npm run build

# 2. 测试 API
npm run cli test "写一个快速排序算法"
```

现在应该可以正常工作了！如果还有问题，请查看调试日志输出的请求内容。

## 调试功能

我添加了请求内容打印功能，运行时会输出：

```
[DEBUG] Request body: {
  "conversationState": {
    "currentMessage": {
      "userInputMessage": {
        "content": "写一个快速排序算法",
        "origin": "CLI"
      }
    },
    "chatTriggerType": "MANUAL"
  }
}
```

这样你可以验证请求格式是否正确。

## 参考文档

详细的技术分析请查看：`BUGFIX_chatTriggerType.md`
